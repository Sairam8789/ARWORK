<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- ... (same as before) ... -->
  </head>
  <body>
    <button id="xrButton">Enter AR</button>
    <canvas id="renderCanvas"></canvas>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        // ... (same as before) ...

        // Handle WebXR
        async function enterAR() {
          if (!navigator.xr) {
            console.error("WebXR not supported on this device/browser.");
            return;
          }

          try {
            // Request a WebXR session
            xrSession = await navigator.xr.requestSession("immersive-ar", {
              requiredFeatures: ["hit-test"],
            });

            // Request the reference space (necessary for AR features)
            const referenceSpace = await xrSession.requestReferenceSpace("local");

            // Use XRWebGLLayer if available, otherwise fallback to regular rendering
            if (isXRWebGLLayerSupported()) {
              // Use the XRWebGLLayer provided by Babylon.js
              const xrLayer = new XRWebGLLayer(xrSession, engine.getRenderingCanvas(), {
                antialias: true,
                ignoreDepthValues: true,
              });

              // Set the XR session's base layer to the XRWebGLLayer
              xrSession.updateRenderState({ baseLayer: xrLayer });

              // Once the XR session starts, hide the box in the regular scene
              box.isVisible = false;

              // Handle the "end" event of the XR session to show the box in the regular scene
              xrSession.addEventListener("end", () => {
                box.isVisible = true;
                document.getElementById("xrButton").style.display = "block";
              });

              // Hide the AR button when the XR session starts
              document.getElementById("xrButton").style.display = "none";

              // Run the XR session
              xrSession.requestAnimationFrame(onXRFrame);
            } else {
              // Fallback to regular rendering if XRWebGLLayer is not available
              box.isVisible = true;
              document.getElementById("xrButton").style.display = "none";
              engine.runRenderLoop(() => {
                scene.render();
              });
            }
          } catch (e) {
            console.error("WebXR not supported or access denied.", e);
          }
        }

        // ... (same as before) ...

        // Add click event listener to the AR button
        document.getElementById("xrButton").addEventListener("click", () => {
          enterAR();
        });

        // Start the rendering loop for the regular scene
        engine.runRenderLoop(() => {
          scene.render();
        });
      });
    </script>
  </body>
</html>
