<!DOCTYPE html>
<html>
  <head>
    <title>Babylon.js AR Placement</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  </head>
  <body>
    <canvas
      id="renderCanvas"
      style="width: 100%; height: 100%; touch-action: none"
    ></canvas>
    <button id="arButton">AR Mode</button>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);

        var createScene = function () {
          var scene = new BABYLON.Scene(engine);
          var camera = new BABYLON.ArcRotateCamera(
            "camera1",
            0,
            0,
            10,
            BABYLON.Vector3.Zero(),
            scene
          );
          camera.attachControl(canvas, true);
          var light = new BABYLON.HemisphericLight(
            "light1",
            new BABYLON.Vector3(0, 1, 0),
            scene
          );

          // Create a ground plane to receive shadows
          // var ground = BABYLON.MeshBuilder.CreateGround(
          //   "ground",
          //   { width: 10, height: 10 },
          //   scene
          // );
          // ground.receiveShadows = true;

          // Function to create a box on the ground
          var box = BABYLON.MeshBuilder.CreateBox("box", { size: 1 }, scene);
          box.position = new BABYLON.Vector3(0, 0.5, 0); // Position the box slightly above the ground
          box.visibility = 1; // Hide the box initially

          // Optionally, add any desired material or color to the box
          // box.material = new BABYLON.StandardMaterial('boxMaterial', scene);
          // box.material.diffuseColor = new BABYLON.Color3(0, 0, 1);

          // Function to enable shadows when entering AR mode
          function enableShadows() {
            scene.lights.forEach(function (light) {
              light.shadowEnabled = true;
            });
          }

          // Check for WebXR support and handle AR button click
          if ("xr" in navigator) {
            navigator.xr
              .isSessionSupported("immersive-ar")
              .then(function (supported) {
                var arButton = document.getElementById("arButton");
                arButton.disabled = !supported;

                if (supported) {
                  arButton.addEventListener("click", function () {
                    var xrExperience = null;

                    if (xrExperience === null) {
                      // Enable shadows when entering AR mode
                      enableShadows();

                      // Create the XR session and handle the AR mode
                      scene
                        .enterXRAsync("immersive-ar")
                        .then(function (defaultExperience) {
                          xrExperience = defaultExperience;
                          box.visibility = 1; // Show the box when entering AR mode
                        });
                    } else {
                      xrExperience.exitXRAsync().then(function () {
                        xrExperience = null;
                        box.visibility = 0; // Hide the box when exiting AR mode
                      });
                    }
                  });
                }
              });
          } else {
            var arButton = document.getElementById("arButton");
            arButton.textContent = "AR Not Supported";
          }

          return scene;
        };

        var scene = createScene();

        // Auto-rotate the camera around the target
        scene.registerBeforeRender(function () {
          scene.activeCamera.alpha += 0.005; // Adjust the rotation speed here (higher value means faster rotation)
        });

        engine.runRenderLoop(function () {
          scene.render();
        });

        window.addEventListener("resize", function () {
          engine.resize();
        });
      });
    </script>
  </body>
</html>
